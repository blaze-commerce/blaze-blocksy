#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-checkout hook for branch naming validation
# Validates branch names when switching or creating branches

# Get the branch being checked out
BRANCH_NAME="$3"

# Only validate if we're checking out a branch (not a commit)
if [ "$1" = "1" ] && [ -n "$BRANCH_NAME" ]; then
    echo "🌿 Validating branch name: $BRANCH_NAME"
    
    # Run branch naming validation for the target branch
    echo "$BRANCH_NAME" | node -e "
        const validator = require('./scripts/branch-naming-validator.js');
        const config = validator.loadConfiguration();
        const branchName = require('fs').readFileSync(0, 'utf8').trim();
        
        if (branchName) {
            const validation = validator.validateBranchName(branchName, config);
            
            if (!validation.valid) {
                console.log('❌ Branch name validation failed');
                validation.errors.forEach(error => console.log('  • ' + error));
                
                if (validation.suggestions.length > 0) {
                    console.log('💡 Suggested names:');
                    validation.suggestions.forEach(suggestion => console.log('  • ' + suggestion));
                }
                
                console.log('🔧 Get help: npm run branch:help');
                process.exit(1);
            } else {
                console.log('✅ Branch name follows ' + validation.pattern + ' pattern');
            }
        }
    "
    
    # Check validation result
    if [ $? -ne 0 ]; then
        echo ""
        echo "❌ Branch checkout blocked due to naming convention violation"
        echo "💡 Use a valid branch name or run: npm run branch:help"
        echo "🚨 Emergency bypass: EMERGENCY_BYPASS=true git checkout $BRANCH_NAME"
        echo ""
        exit 1
    fi
fi
