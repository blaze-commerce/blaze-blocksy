name: Auto-Merge Security Monitor

# This workflow monitors all auto-merge activities and provides security alerts
# It runs when PRs are merged to ensure only authorized auto-merges occurred

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  monitor-auto-merge:
    name: Monitor auto-merge security
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        continue-on-error: true
        with:
          app-id: ${{ secrets.BLAZECOMMERCE_BOT_APP_ID }}
          private-key: ${{ secrets.BLAZECOMMERCE_BOT_PRIVATE_KEY }}

      - name: Fallback to GITHUB_TOKEN if App Token fails
        id: token-fallback
        run: |
          if [ "${{ steps.app-token.outcome }}" = "failure" ]; then
            echo "token=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
          else
            echo "token=${{ steps.app-token.outputs.token }}" >> $GITHUB_OUTPUT
          fi

      - name: Analyze merged PR
        env:
          GH_TOKEN: ${{ steps.token-fallback.outputs.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE_RAW: ${{ github.event.pull_request.title }}
          PR_AUTHOR_RAW: ${{ github.event.pull_request.user.login }}
          MERGED_BY_RAW: ${{ github.event.pull_request.merged_by && github.event.pull_request.merged_by.login || 'unknown' }}
        run: |
          set -euo pipefail

          # Sanitize inputs (env vars are safe from shell injection, but sanitize for downstream use)
          sanitize_input() {
            echo "$1" | sed 's/[^a-zA-Z0-9 ._():-]//g' | head -c 200
          }

          # Validate PR number
          if ! [[ "$PR_NUMBER" =~ ^[0-9]+$ ]]; then
            echo "‚ùå Invalid PR number: $PR_NUMBER"
            exit 1
          fi

          PR_TITLE=$(sanitize_input "$PR_TITLE_RAW")
          PR_AUTHOR=$(sanitize_input "$PR_AUTHOR_RAW")
          MERGED_BY=$(sanitize_input "$MERGED_BY_RAW")

          # Handle null/empty values
          [ -z "$PR_TITLE" ] && PR_TITLE="[Title unavailable]"
          [ -z "$PR_AUTHOR" ] && PR_AUTHOR="[Author unavailable]"
          [ -z "$MERGED_BY" ] || [ "$MERGED_BY" = "null" ] && MERGED_BY="unknown"

          echo "üîç Analyzing merged PR #$PR_NUMBER"
          echo "Title: $PR_TITLE"
          echo "Author: $PR_AUTHOR"
          echo "Merged by: $MERGED_BY"

          # Check if author was the automation bot
          IS_BOT_AUTHOR=false
          if [ "$PR_AUTHOR" = "blazecommerce-automation-botbot" ]; then
            IS_BOT_AUTHOR=true
          fi

          echo "Is bot author: $IS_BOT_AUTHOR"

          # Security validation ‚Äî log all merges, alert on unexpected bot-authored PRs
          if [ "$IS_BOT_AUTHOR" = "false" ]; then
            echo "‚úÖ Regular development PR merged through standard process"
            echo "üë• Manual review process: FOLLOWED"
          else
            echo "‚ö†Ô∏è Bot-authored PR detected ‚Äî investigating"

            # Create security alert issue for unexpected bot PRs
            gh issue create \
              --title "Auto-Merge Security Alert: Bot-authored PR #${PR_NUMBER}" \
              --body "$(cat <<EOF
          ## Security Alert: Bot-Authored PR Merged

          A PR authored by the automation bot was merged. Since version bump PRs
          are no longer created (versions are committed directly to main), this
          is unexpected and should be reviewed.

          **PR Details:**
          - **Number**: #${PR_NUMBER}
          - **Title**: ${PR_TITLE}
          - **Author**: ${PR_AUTHOR}
          - **Merged by**: ${MERGED_BY}

          **Action Required:**
          Please review this merge to ensure it followed proper security protocols.

          **Auto-generated by**: [Auto-Merge Security Monitor](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/auto-merge-monitor.yml)
          EOF
          )" \
              --label "security,alert" \
              --assignee "lanz-2024"

            echo "üö® Security alert issue created"
          fi

      - name: Log merge statistics
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          MERGED_BY: ${{ github.event.pull_request.merged_by && github.event.pull_request.merged_by.login || 'unknown' }}
          TARGET_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "üìä Merge Statistics:"
          echo "- PR #${PR_NUMBER}"
          echo "- Author: ${PR_AUTHOR}"
          echo "- Merged by: ${MERGED_BY}"
          echo "- Target branch: ${TARGET_BRANCH}"
          echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "‚úÖ Security monitoring completed"
